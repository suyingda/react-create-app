<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>zfpx</title>

</head>

<body>
<span>a的值：{{a.aa}} </span>
<div>c的值：{{c}}</div>
<div id="app">
    <div>b的值：{{b}}</div>
</div>


<script src="index.js"></script>
<script>
    // let vjs = new Vjs({
    //     el: '#app',
    //     data: {a: {aa: 1}, b: '2', c: '大大'}
    // })


    let obj = {
        b: 1
    }
    let newVal = obj.b
    let dep = new Dep();
    Object.defineProperty(obj, 'b', {
        // enumerable: true,
        get: function () {
            Dep.target && dep.addSub(Dep.target);
            console.log(dep, 'get')
            return newVal;
        },
        set: function (val) {
            if (newVal === val) return;
            newVal = val;
            dep.notify();
            console.log(dep, 'set')
        }
    })

    function wendang() {
        let Domdata = document.querySelector('#app')
        let fromdata = document.createDocumentFragment();
        while (Domdata.firstChild) {
            fromdata.appendChild(Domdata.firstChild)
        }
        let x = Array.from(fromdata.childNodes);
        let reg = /\{\{(.*)\}\}/;
        x.forEach((items) => {
            let text = items.textContent;
            if (reg.test(text) && items.nodeType !== 3) {
                let arr = RegExp.$1.split('.');
                let val = obj;
                arr.forEach((arritems) => {
                    val = val[arritems]
                })
                new Watcher(obj, RegExp.$1, function (newVal) {
                    items.textContent = text.replace(reg, newVal)
                    }
                )
                items.textContent = text.replace(reg, val)
            }
            console.log(items.textContent);
        })

        Domdata.appendChild(fromdata)
    }

    function Dep() {
        this.subs = [];
    }

    Dep.prototype.addSub = function (sub) {
        this.subs.push(sub)
    }
    Dep.prototype.notify = function () {
        this.subs.forEach((sub) => {
            sub.update()
        });
    }

    function Watcher(vm, exp, fn) {  console.log('new Watcher');
        this.vm = vm;
        this.exp = exp;
        this.fn = fn;
        Dep.target = this;
        // let val = vm;
        // let arr = exp && exp.split('.');
        // arr && arr.forEach(function (k) {  //this.a.a
        //     val = val[k]
        // });
        // Dep.target = null;
    }

    Watcher.prototype.update = function () {
        let val = this.vm;
        let arr = this.exp && this.exp.split('.');
        arr && arr.forEach(function (k) {  //this.a.a
            val = val[k]
        });
        this.fn('总听不见');
    }


    wendang();
</script>

</body>

</html>